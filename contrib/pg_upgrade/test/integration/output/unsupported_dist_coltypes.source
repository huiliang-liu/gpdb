-- given: tables with distribution column type using abstime, reltime, tinterval, money
-- when: upgrade check is performed
-- then: fails listing the tables which have these columns
CREATE TABLE unsupported_dist_col_abstime(a abstime) DISTRIBUTED BY(a);
CREATE
INSERT INTO unsupported_dist_col_abstime VALUES ('1901-12-14');
INSERT 1
CREATE TABLE unsupported_dist_col_reltime(a reltime) DISTRIBUTED BY(a);
CREATE
INSERT INTO unsupported_dist_col_reltime VALUES ('1 year');
INSERT 1
CREATE TABLE unsupported_dist_col_tinterval(a tinterval) DISTRIBUTED BY(a);
CREATE
INSERT INTO unsupported_dist_col_tinterval VALUES ('["May 10, 1947 23:59:12" "Jan 14, 1973 03:14:21"]');
INSERT 1
CREATE TABLE unsupported_dist_col_money(a money) DISTRIBUTED BY(a);
CREATE
INSERT INTO unsupported_dist_col_money VALUES ('34.23');
INSERT 1


! ./gpdb6/bin/pg_upgrade --mode=dispatcher --old-gp-dbid=1 --new-gp-dbid=1 --check --old-bindir=@upgrade_test_path@/gpdb5/bin --new-bindir=@upgrade_test_path@/gpdb6/bin --old-datadir=@upgrade_test_path@/gpdb5-data/qddir/demoDataDir-1 --new-datadir=@upgrade_test_path@/gpdb6-data/qddir/demoDataDir-1 --old-port=@old_port@;
Performing Consistency Checks on Old Live Server
------------------------------------------------
Creating a dump of all tablespace metadata.                 ok
Checking for abstime, reltime, tinterval user data types    fatal

Your installation contains a user table, that uses a 'abstime',
'reltime', 'tinterval', 'money' or 'anyarray' type as a distribution key column. Using
these datatypes as distribution keys is no longer supported. You can use
ALTER TABLE ... SET DISTRIBUTED RANDOMLY to change the distribution keys,
and restart the upgrade.  A list of the problem columns is in the file:
    tables_using_abstime_reltime_tinterval.txt

Failure, exiting


CREATE TABLE problematic_tables_info (colinfo text);
CREATE
! /bin/cat tables_using_abstime_reltime_tinterval.txt | tail -n +2 | tr -d ' ' > @upgrade_test_path@/temp_tables_using_abstime_reltime_tinterval.txt ;

COPY problematic_tables_info FROM '@upgrade_test_path@/temp_tables_using_abstime_reltime_tinterval.txt';
COPY 4
SELECT * FROM problematic_tables_info;
 colinfo                                 
-----------------------------------------
 public.unsupported_dist_col_tinterval.a 
 public.unsupported_dist_col_abstime.a   
 public.unsupported_dist_col_reltime.a   
 public.unsupported_dist_col_money.a     
(4 rows)

-- before upgrade, change the distribution policy to random distribution
ALTER TABLE unsupported_dist_col_abstime SET DISTRIBUTED RANDOMLY;
ALTER
ALTER TABLE unsupported_dist_col_reltime SET DISTRIBUTED RANDOMLY;
ALTER
ALTER TABLE unsupported_dist_col_tinterval SET DISTRIBUTED RANDOMLY;
ALTER
ALTER TABLE unsupported_dist_col_money SET DISTRIBUTED RANDOMLY;
ALTER
